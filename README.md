## 项目概述

`rDownloader` 是一个用 Rust 编写的、支持断点续传和多线程加速的智能下载器。项目旨在提供一个高性能、健壮、模块化的命令行下载工具。

项目采用 Cargo 工作区（Workspace）架构，将不同的功能逻辑分离到独立的包（Crate）中，使得项目结构清晰，易于维护和扩展。

### 技术栈

- **语言**: Rust
- **异步运行时**: `tokio`
- **HTTP 客户端**: `reqwest`
- **命令行解析**: `clap`
- **进度条显示**: `indicatif`
- **序列化/反序列化**: `serde`, `serde_json`
- **正则表达式**: `regex`

## 项目架构

项目由以下四个核心包组成：

1.  `rdownloader-cli` (命令行接口):
    *   **职责**: 用户交互的入口。
    *   **功能**: 解析用户输入的参数（如 URL、输出路径等），调用调度中心执行下载，并向用户报告最终结果。

2.  `rdownloader-dispatcher` (调度与决策中心):
    *   **职责**: 下载策略的决策者。
    *   **功能**: 作为 CLI 和下载执行者之间的中间层。它通过“智能探测”来决定应该采用多线程还是单线程下载模式，并将任务分发给 `http` 库。

3.  `rdownloader-http` (下载执行者):
    *   **职责**: 实现具体的 HTTP/S 下载逻辑。
    *   **功能**: 内部实现了统一的、基于状态文件的断点续传逻辑，支持多线程并发下载和单线程顺序下载。

4.  `rdownloader-utils` (公共工具库):
    *   **职责**: 提供项目内多个包共享的辅助函数。
    *   **功能**: 包含路径处理、智能分块计算、HTTP 头解析、文件名提取等可复用的工具函数。

## 核心逻辑详解

### 1. 智能探测与重试 (`dispatcher`)

为了在复杂的网络环境（特别是 CDN）下保证成功率，调度中心采用带重试的单步探测策略：

1.  **单一探测请求**: 程序发送**一次**网络请求（`GET` + `Range: bytes=0-1`）来获取所有决策所需信息。
2.  **自动重试**: 考虑到 CDN 等网络环境可能存在临时性错误（如返回非标准的 `618` 状态码），探测请求被包裹在一个**重试循环**中（最多3次）。如果一次探测失败，程序会等待一小段时间后自动重试，大大提高了在真实网络环境下的稳定性。
3.  **决策逻辑**: 
    *   探测成功后，优先检查 `Content-Range` 头来获取文件总大小。
    *   如果失败，则回退到检查 `Content-Length` 和 `Accept-Ranges: bytes` 头。
    *   根据文件大小和服务器对并发的支持情况，最终决定采用多线程或单线程模式。

### 2. 文件完整性与断点续传 (`http`)

为保证下载文件的绝对正确并实现全自动续传，我们实现了双重校验机制。

1.  **状态文件**: 对于每个下载任务，程序都会创建一个 `.rdownload` 状态文件，记录了 URL、文件大小、ETag 和所有数据块的完成状态。

2.  **ETag 校验 (防文件更新)**: 
    *   续传时，程序会先获取服务器上当前文件的 `ETag`（相当于文件“指纹”），并与状态文件中记录的旧 `ETag` 对比。
    *   如果不一致，说明文件已被更新。程序会自动删除旧文件和状态文件，从零开始下载，防止新旧文件内容混杂。

3.  **Content-Type 校验 (防内容欺骗)**:
    *   在探测阶段，程序会记录下文件的正确 `Content-Type`（如 `application/octet-stream`）。
    *   在并发下载**每一个**数据块时，程序都会再次检查其响应头中的 `Content-Type`。
    *   如果数据块的 `Content-Type` 与探测时记录的不符（例如，服务器返回了一个 `text/html` 的错误页面），则该数据块下载失败。**此举可有效防止因 CDN 安全策略而导致的静默数据损坏**。

### 3. 命令行接口 (`cli`)

为了提升易用性，命令行参数被设计得更符合直觉：

-   **URL**: 作为必需的位置参数，无需前缀标志（如 `--url`）。
-   **输出 (`-o`, `--output`)**: 一个灵活的参数，既可以接受一个目录（此时程序会自动检测并使用原始文件名），也可以接受一个完整的文件路径（用于重命名）。
-   **日志 (`-c`, `--log-conf`)**: 一个可选参数，用于指定 `log4rs` 的配置文件路径，给予用户完全的日志控制能力。
